<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/main.css">
  <link rel="icon" type="image/x-icon" href="/static/euroscipy_logo.svg">
  <title>
Recent Developments in Pytensor, the Successor Package to Theano
</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap"
    rel="stylesheet">

  <meta property="og:title"
    content="Recent Developments in Pytensor, the Successor Package to Theano">

  
  <meta name="image" property="og:image:secure_url" content="/static/talks/LR7S8P.png">
  <meta name="image" property="og:image" content="/static/talks/LR7S8P.png">
  

  <meta property="og:description" content="The EuroSciPy meeting is a cross-disciplinary gathering focused on the use and development of the Python language in scientific research.">
  <meta property="og:url" content="https://euroscipy.org">
  <meta property="og:type" content="article">
  <meta property=“article:publisher“ content="https://euroscipy.org">
  <meta property=“og:site_name“ content="EuroSciPy" />

  <meta property=“og:image:type“ content="image/png" />
  <meta property=“og:image:width“ content=“1200″ />
  <meta property=“og:image:height“ content=“630″ />

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@euroscipy">
  <meta name="twitter:title"
    content="Recent Developments in Pytensor, the Successor Package to Theano">
  <meta name="twitter:description" content="">
  
  <meta name="twitter:image" content="/static/talks/LR7S8P.png">
  

  
  
</head>

<body>
  <label class="hamburger-menu">
    <input type="checkbox" />
  </label>

  <aside class="sidebar">
    <nav aria-label="Site Navigation">
      <ul class="nav main-navigation">
        <li class="navigation-link"><a href="/"><img src="/static/euroscipy_logo.svg" alt="euroscipy"></a></li>
        
        <li class="navigation-link"><a href="/schedule">Schedule</a></li>
        
        <li class="navigation-link"><a href="/tickets">Tickets</a></li>
        
        <li class="navigation-link"><a href="/finaid">Financial Aid</a></li>
        
        <li class="navigation-link"><a href="/talks">Talks</a></li>
        
        <li class="navigation-link"><a href="/blog">Blog</a></li>
        
        <li class="navigation-link"><a href="/sponsors">Sponsors</a></li>
        
        <li class="navigation-link"><a href="/sponsoring">Sponsoring</a></li>
        
        <li class="navigation-link"><a href="/sprints">Sprints</a></li>
        
        <li class="navigation-link"><a href="/team">Team</a></li>
        
        <li class="navigation-link"><a href="/venue">Venue</a></li>
        
        <li class="navigation-link"><a href="/faq">FAQ</a></li>
        
        <li class="navigation-link"><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </aside>

  

<div class="content">
    <div class="talk-details">
        Wednesday 13:30
        
        in room 1.38 (ground floor)
        
    </div>

    <h2>Recent Developments in Pytensor, the Successor Package to Theano</h2>
    <h3>Jesse Grabowski, Ricardo Vieira</h3>

    <div class="description">
        <p>After MILA offically stopped development of Theano in 2018, the PyMC project forked the project and continued developing the package under a series of names: Theano-PyMC, Aesara, and now Pytensor. This choice was motivated by Theano's decision to put static computational graphs directly in front of the user.  This choice turned out to be ideal for Bayesian inference, because it allows for powerful graph-to-graph transformations. For example, a graph that defines a data generating process via draws from random variables can be automatically translated into a backwards process describing the log probability of observed data, conditioned on draws from prior distributions. This is precisely the same logic that underpins reverse-mode automatic differentiation. It turns out this idea of graph transformation is extremely powerful, and development of Pytensor has focused on fully leveraging this power.</p>
<p>Recently, new features have been added to Pytensor, making it a powerful tool for workflows in statistics, machine learning, and Bayesian modeling. One of the most powerful features of Theano was it's use of graph rewrites to optimize computation beyond what a compiler is willing or able to do. A canonical example is to rewrite the express <code>log(1 + x)</code> to <code>log1p(x)</code>, a version of the computation that remains numerically stable for small values of <code>x</code>. Pytensor has fully embraced the system of graph rewrites, and has expanded it to include many new cases, including:</p>
<ul>
<li>Op fusion: finding sub-graphs that are re-used multiple times on different inputs. These are fused into a single composite Op, compiled once, and re-used.</li>
<li>Aggressive inplacing: identifying all cases where intermediate computations can performed destructively "in-place", alleviated the need for expensive memory allocations</li>
<li>Pre-gradient stabilization: maintain a library of mathematically "non-destructive" rewrites that simplify arbitrary user expressions into simpler forms, leading to cleaner gradient graphs after applying autodiff</li>
<li>Linear algebra optimization: reason about the types of matrices in a graph, and automatically apply specializations to expensive operations. For example, <code>det(diag(x))</code> is rewritten to <code>prod(diag(x))</code>, and <code>inv(kron(a, b))</code> to <code>kron(inv(a), inv(b))</code>.</li>
</ul>
<p>These rewrites are possible because as a user writes Pytensor code, a static graph is constructed. At any time, the user can inspect the graph, or directly intervene on it. These interventions include extracting sub-graphs, replacing or removing inputs or functions, or applying entire graph-to-graph transformations. The majority of our talk will focus on this last operation, which represents one of the most unique and powerful features of Pytensor. This capability was first used in Theano to perform automatic differentiation. Given a forward graph of a scalar loss function, a gradient graph can be created by walking backwards from the loss in topological order, applying the chain rule. Graph-to-graph transformations can go far beyond this application. We present the following examples:</p>
<ul>
<li><p><em>Vectorization</em>. Pytensor can replace an n-dimensional input with an (n+k) dimensional input, then propagate the consequences through the graph. For example, <code>dot(matrix, vector)</code> can be replaced with <code>dot(tensor3, vector)</code>, and Pytensor will automatically apply a batched dot product across the left-most dimension of the <code>tensor3</code> input. The new output shape will also be propagated to any down-stream computations.</p>
</li>
<li><p><em>Automatic probability derivation</em>. The PyMC package uses to Pytensor to transform a user-defined generative graph, which produces samples of data from priors and inputs, to a graph that gives the probability of observing an output sample, given parameters. In this way, a single model declaration is reused for both inference via Bayes' Law, and for pre- and post-estimation tasks that require forward sampling</p>
</li>
<li><p><em>Automatic marginalization</em>. Similarly, having access to the full graph lets Pytensor reason about non-trivial graph replacements, such as automatic marginalization of random variables. This can remove nuisance parameters from a model and significantly speed up inference algorithms. In addition, because pytensor can graphically verify that batch dimensions remain independent, the algorithm is bounded by the size of the domain of the random variables, rather than by their actual input size. When marginalizing a hidden markov chain, for example, this means we only have to do <code>states * steps</code> computations, instead of <code>states ^ steps</code> (this is the celebrated "forward algorithm").</p>
</li>
</ul>
<p>We also give several examples where Pytensor offers advantages in deep learning contexts, including:</p>
<ul>
<li><em>Training to prediction transformation</em>: A common source of errors when working with deep learning models is forgetting to manually remove training-only Ops like dropout and batch norm. Pytensor can automate these tasks using rewrites, which can be automatically applied by a deep learning API built on top of pytensor</li>
</ul>
<p>-<em>Op Specialization</em>: Certain extremely expensive layers used in deep learning, including convolutions and transformers, have specialized forms that can be used when the right conditions are met. Examples include FFT-convolution and FlashAttention. Pytensor can recognize Op sequences of the form <code>matmul-mask-softmax-dropout-matmul</code> and replace them with a single <code>FlashAttention</code> Op. Similarly, convolution Ops can be replaced with FFT convolutions when the kernels are sufficiently large. Both of these optimizations can be done automatically, without users necessarily having to know the intricacies of when and how these specialized versions should be used.</p>
<p>We conclude with a short description of planned features for our upcoming Pytensor 3.0 release, and an invitation for interested audience members to try the package and submit issues/PRs.</p>

    </div>

    <div class="authors">
        <h3 id="jesse-grabowski">Jesse Grabowski</h3><p>Jesse Grabowski is a PhD candidate at Paris 1 Pantheon-Sorbonne. He is also a principal data scientist at PyMC labs, and a core developer of PyMC, Pytensor, and related packages. His area of research includes time series modeling, macroeconomics, and finance.</p>
<h3 id="ricardo-vieira">Ricardo Vieira</h3>
    </div>

    <div class="social-card-image">
        <img src="/static/talks/LR7S8P.png" alt="">
    </div>
</div>



  <div class="content footer">
    <ul class="legal-links">
      <li><a href="/code-of-conduct">code of conduct</a></li>
      <li><a href="/imprint">imprint</a></li>
      <li><a href="https://archive.euroscipy.org/">archive</a></li>
    </ul>

    <ul class="contact">
      <li><a href="mailto:info@euroscipy.org">email</a></li>
      <li>
          <a
          href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fwww.euroscipy.org%2F2019%2F&ref_src=twsrc%5Etfw&region=follow_link&screen_name=euroscipy&tw_p=followbutton">x</a>
      </li>
    </ul>
  </div>
</body>

</html>
